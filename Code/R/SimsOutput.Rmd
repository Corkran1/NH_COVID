---
title: "Simulation Outputs"
output: html_notebook
---

```{r}
### Libraries
library(dplyr); library(ggplot2); library(ggpubr)
#Total population
N <- 170 + 174
# ==============================================================================
# FUNCTIONS
# ==============================================================================
# Read Simulations
# ------------------------------------------------------------------------------
ReadSims <- function(dir){
  # dir = paste0(p, "00/EC/")
  f <- list.files(dir, full.names = TRUE)
  L <- lapply(1:length(f), function(x){
    read.csv(f[x], fileEncoding = 'UTF-8') %>% # read files
      mutate(Sim = x, day = ceiling(cycle/24)) %>% # create variable for sim number and day
      group_by(Sim, day) %>% # group by simulation and day
      summarise_all(.funs = max) %>%# get the max for all the records.
      ungroup()
    })
  
  N_sim <- lapply(L, nrow) %>% unlist() %>% max(.)
  
  L <- lapply(L, function(x){
    d <- N_sim - nrow(x)
      x %>%
        slice(c(1:nrow(.), rep(nrow(.), each = d))) %>%
        mutate(day = 1:n())
  })
  L %>%
    do.call(rbind, .)
}
# Functions for getting quantiles
# ------------------------------------------------------------------------------
Q25 <- function(sims) quantile(sims, 0.25)
Q75 <- function(sims) quantile(sims, 0.75)
# Function for summarizing the cycles
# ------------------------------------------------------------------------------
CycleSums <- function(sims){
  # sims = D00
  cycle_IQR <- sims %>%
    dplyr::select(-Sim) %>%
    group_by(day) %>%
    summarise_all(.funs = c(Median = median, Q25 = Q25, Q75 = Q75))
  
  cycle_TTE <- sims %>%
    group_by(Sim) %>%
    filter(I == max(I)) %>%
    filter(cycle == max(cycle)) %>%
    mutate(day = floor(cycle/24))
  
  return(list(cycle_IQR = cycle_IQR, cycle_TTE = cycle_TTE))
}

# Function for the plots
# ------------------------------------------------------------------------------
PlotCycles <- function(sims, var, col, y_lim){
  # sims = D00; var = "I"; col = "red3"
  # y_lab = ifelse(grepl("_P", var), "Infected \n pig herds", "Infected \n wild boar")
  p = sims %>%
    CycleSums() %>%
    .$cycle_IQR %>%
    ggplot(aes(x = day)) +
    geom_line(aes(y = eval(parse(text = paste0(var, '_Median')))),
      col = col, lwd = 1) +
    geom_ribbon(aes(
      ymin = eval(parse(text = paste0(var, '_Q25'))),
      ymax = eval(parse(text = paste0(var, '_Q75')))),
      alpha = 0.3, fill = col) +
    ylab("Number of Infected") +
    theme_minimal() 
    # ylab(y_lab) +
  #   xlab("Days") +
  #   theme(legend.position = "none",
  #     axis.title.y = element_text(angle = 0, vjust = 0.5))
  # if( !missing(y_lim) ) p = p + ylim(y_lim)
  p
  
}
#### Function for time to eradication ####
#----------------------------------------#
TE_data <- function(data){
  data %>%
    mutate(day = floor(cycle/24)) %>%
    group_by(Sim, day) %>%
    summarise(I = max(I)) %>%
    group_by(Sim) %>%
    filter(I == max(I)) %>%
    filter(day == max(day))
}
```
# Baseline

```{r}
p <- "../../Data/SimsOut/Baseline/"
ColPal <- c("grey40")
### 75% Detection Probability
D00 <- ReadSims(p)
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Baseline')
##### NUMBER OF INFECTED ####
CumI_p <- rbind(I00) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r/N, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  ylab("Infection rate") +
  ggtitle("Epidemic Size")
##### EPIDEMIC LENGTH ####
EpiL_p <- rbind(I00) %>% 
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  facet_grid(~Scenario) +
  ggtitle(" Epidemic duration")

CumI_p; EpiL_p
ggarrange(CumI_p, EpiL_p, ncol = 2, common.legend = T) %>%
  annotate_figure(text_grob("Baseline Scenario", color = "grey20", face = "bold", size = 14)) %>%
  ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/Baseline.png", width = 8, height = 4)
```


# Sensitivity analysis

## Detection probability

00 - 75% detection probability
01 - 85% detection probability
02 - 95% Detection probability

```{r DetectionProbability SA}
p <- "../../Data/SimsOut/SensitivityAnalysis/DetectionProbability/"
ColPal <- c("#00827E", "#00CFB7", "#94F2EF")
### 75% Detection Probability
D00 <- ReadSims(paste0(p, "00/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '75% Detection Probability')
### 85% Detection Probability
D01 <- ReadSims(paste0(p, "01/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '85% Detection Probability')
### 95% Detection Probability
D02 <- ReadSims(paste0(p, "02/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '95% Detection Probability')
##### NUMBER OF INFECTED ####
CumI_p <- rbind(I00, I01, I02) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r/N, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  ylab("Infection rate") +
  ggtitle("Epidemic Size")
##### EPIDEMIC LENGTH ####
EpiL_p <- rbind(I00, I01, I02) %>% 
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  facet_grid(~Scenario) +
  ggtitle(" Epidemic duration")


ggarrange(CumI_p, EpiL_p, nrow = 2, common.legend = T) %>%
  annotate_figure(text_grob("Probability of Detection", color = "grey20", face = "bold", size = 14)) %>%
  ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/ProbDetection.png", width = 9, height = 5)
```

## Introduction probability

00 - 0.01
01 - 0.05
02 - 0.1

```{r Introduction}
p <- "../../Data/SimsOut/SensitivityAnalysis/IntroductionProbability/"
ColPal <- c("#704500", "#6E6A00", "#076600")
### 1% Introduction Probability
D00 <- ReadSims(paste0(p, "00/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '1% Introduction Probability')
### 5% Introduction Probability
D01 <- ReadSims(paste0(p, "01/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '5% Introduction Probability')
### 10% Introduction Probability
D02 <- ReadSims(paste0(p, "02/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '10% Introduction Probability')
##### NUMBER OF INFECTED ####
CumI_p <- rbind(I00, I01, I02) %>%
  mutate(Scenario = factor(Scenario, levels = c('1% Introduction Probability', '5% Introduction Probability', '10% Introduction Probability'))) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r/N, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  ylab("Infection rate") +
  ggtitle("Epidemic Size")
##### EPIDEMIC LENGTH ####
EpiL_p <- rbind(I00, I01, I02) %>% 
  mutate(Scenario = factor(Scenario, levels = c('1% Introduction Probability', '5% Introduction Probability', '10% Introduction Probability'))) %>%
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  facet_grid(~Scenario) +
  ggtitle(" Epidemic duration")

ggarrange(CumI_p, EpiL_p, nrow = 2, common.legend = T) %>%
  annotate_figure(text_grob("Probability of Introduction", color = "grey20", face = "bold", size = 14)) %>%
  ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/Introduction.png", width = 9, height = 5)
```
## Transmission probability

00 - 0.3
01 - 0.5
02 - 0.7

```{r Transmission}
p <- "../../Data/SimsOut/SensitivityAnalysis/TransmissionProbability/"
ColPal <- c("#B284E3", "#DE8ABE", "#F28C8C")
### 1% Introduction Probability
D00 <- ReadSims(paste0(p, "00/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Low transmission')
### 5% Introduction Probability
D01 <- ReadSims(paste0(p, "01/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Medium transmission')
### 10% Introduction Probability
D02 <- ReadSims(paste0(p, "02/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'High transmission')
##### NUMBER OF INFECTED ####
CumI_p <- rbind(I00, I01, I02) %>%
  mutate(Scenario = factor(Scenario, levels = c('Low transmission', 'Medium transmission', 'High transmission'))) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r/N, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  ylab("Infection rate") +
  ggtitle("Epidemic Size")
##### EPIDEMIC LENGTH ####
EpiL_p <- rbind(I00, I01, I02) %>% 
  mutate(Scenario = factor(Scenario, levels = c('Low transmission', 'Medium transmission', 'High transmission'))) %>%
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  facet_grid(~Scenario) +
  ggtitle(" Epidemic duration")

ggarrange(CumI_p, EpiL_p, nrow = 2, common.legend = T) %>%
  annotate_figure(text_grob("Transmission rate", color = "grey20", face = "bold", size = 14)) %>%
  ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/Transmission.png", width = 9, height = 5)
```

## Effect of Face masks (PPE)

00 - LB
01 - Estimate
02 - UB

```{r FaceMasks}
p <- "../../Data/SimsOut/SensitivityAnalysis/FaceMasks/"
ColPal <- c("#5C9669", "#6A918C", "#7280B3")
### 1% Introduction Probability
D00 <- ReadSims(paste0(p, "00/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Higly effective')
### 5% Introduction Probability
D01 <- ReadSims(paste0(p, "01/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Medium effective')
### 10% Introduction Probability
D02 <- ReadSims(paste0(p, "02/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Low effective')
##### NUMBER OF INFECTED ####
CumI_p <- rbind(I00, I01, I02) %>%
  mutate(Scenario = factor(Scenario, levels = c('Higly effective', 'Medium effective', 'Low effective'))) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r/N, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  ylab("Infection rate") +
  ggtitle("Epidemic Size")
##### EPIDEMIC LENGTH ####
EpiL_p <- rbind(I00, I01, I02) %>% 
  mutate(Scenario = factor(Scenario, levels = c('Higly effective', 'Medium effective', 'Low effective'))) %>%
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  facet_grid(~Scenario) +
  ggtitle(" Epidemic duration")

ggarrange(CumI_p, EpiL_p, nrow = 2, common.legend = T) %>%
  annotate_figure(text_grob("Effect of PPE", color = "grey20", face = "bold", size = 14)) 
# %>%
#   ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/PPE.png", width = 9, height = 5)
```


# Scenario Modeling

## Testing Frequency

```{r}
p <- "../../Data/SimsOut/Scenarios/TestingFreq/"
ColPal <- c("#5C9669", "#6A918C", "#7280B3")
### Same vaccine effect for residents and staff
D00 <- ReadSims(paste0(p, "00/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '7 days')
### Different vaccine effect for residents and staff (Pfizer)
D01 <- ReadSims(paste0(p, "01/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '5 days')
### Different vaccine effect for residents and staff (Pfizer)
D02 <- ReadSims(paste0(p, "02/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '3 days')
##### NUMBER OF INFECTED ####
CumI_p <- rbind(I00, I01, I02) %>%
  mutate(Scenario = factor(Scenario, levels = c('7 days', '5 days', '3 days'))) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r/N, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  ylab("Infection rate") +
  ggtitle("Epidemic Size")
##### EPIDEMIC LENGTH ####
EpiL_p <- rbind(I00, I01, I02) %>% 
  mutate(Scenario = factor(Scenario, levels = c('7 days', '5 days', '3 days'))) %>%
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  facet_grid(~Scenario) +
  ggtitle(" Epidemic duration")

ggarrange(CumI_p, EpiL_p, nrow = 2, common.legend = T) %>%
  annotate_figure(text_grob("Testing Frequency", color = "grey20", face = "bold", size = 14)) %>%
  ggsave(filename = "../../Documentation/Figures/Scenarios/TestingFreq.png", width = 9, height = 5)
```

## Vaccine distribution

```{r}
p <- "../../Data/SimsOut/Scenarios/VaccineDistrib/"
ColPal <- c("#5C9669", "#6A918C", "#7280B3")
### Same vaccine effect for residents and staff
D00 <- ReadSims(paste0(p, "00/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Equal distribution')
### Different vaccine effect for residents and staff (Pfizer)
D01 <- ReadSims(paste0(p, "01/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Staff priority')
### Different vaccine effect for residents and staff (Pfizer)
D02 <- ReadSims(paste0(p, "02/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Resident priority')
##### NUMBER OF INFECTED ####
CumI_p <- rbind(I00, I01, I02) %>%
  mutate(Scenario = factor(Scenario, levels = c('Equal distribution', 'Staff priority', 'Resident priority'))) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r/N, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  ylab("Infection rate") +
  ggtitle("Epidemic Size")
##### EPIDEMIC LENGTH ####
EpiL_p <- rbind(I00, I01, I02) %>% 
  mutate(Scenario = factor(Scenario, levels = c('Equal distribution', 'Staff priority', 'Resident priority'))) %>%
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  facet_grid(~Scenario) +
  ggtitle(" Epidemic duration")

ggarrange(CumI_p, EpiL_p, nrow = 2, common.legend = T) %>%
  annotate_figure(text_grob("Vaccine Distribution", color = "grey20", face = "bold", size = 14)) %>%
  ggsave(filename = "../../Documentation/Figures/Scenarios/VaccinationDist.png", width = 9, height = 5)
```

## Vaccine Effect

```{r}
p <- "../../Data/SimsOut/Scenarios/VaccineEffect/"
ColPal <- c("#5C9669", "#6A918C", "#7280B3")
### Same vaccine effect for residents and staff
D00 <- ReadSims(paste0(p, "00/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Same vaccine effect')
### Different vaccine effect for residents and staff (Pfizer)
D01 <- ReadSims(paste0(p, "01/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Pfizer')
### Different vaccine effect for residents and staff (Pfizer)
D02 <- ReadSims(paste0(p, "02/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Moderna')
##### NUMBER OF INFECTED ####
CumI_p <- rbind(I00, I01, I02) %>%
  mutate(Scenario = factor(Scenario, levels = c('Same vaccine effect', 'Pfizer', 'Moderna'))) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r/N, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  ylab("Infection rate") +
  ggtitle("Epidemic Size")
##### EPIDEMIC LENGTH ####
EpiL_p <- rbind(I00, I01, I02) %>% 
  mutate(Scenario = factor(Scenario, levels = c('Same vaccine effect', 'Pfizer', 'Moderna'))) %>%
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  facet_grid(~Scenario) +
  ggtitle(" Epidemic duration")

ggarrange(CumI_p, EpiL_p, nrow = 2, common.legend = T) %>%
  annotate_figure(text_grob("Vaccine Effect", color = "grey20", face = "bold", size = 14)) %>%
  ggsave(filename = "../../Documentation/Figures/Scenarios/Vaccination.png", width = 9, height = 5)
```


## Scenario 1

## Scenario 2






# |------ Legacy Code (prvious work) ------|

## Use of PPE

### Effectiveness of PPE

```{r}
p <- "../../Data/SimsOut/PPE/"
ColPal <- c("#FF4040", "#FFA024", "#FFC64C", "#D6E020")
### USE OF PPE by 90% of population with a 60% of effectiveness
D00 <- ReadSims(paste0(p, "00/EC/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '70% PPE Effect')
### USE OF PPE by 90% of population with a 60% of effectiveness
D01 <- ReadSims(paste0(p, "01/EC/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '80% PPE Effect')
### USE OF PPE by 90% of population with a 80% of effectiveness
D02 <- ReadSims(paste0(p, "02/EC/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '85% PPE Effect')

#### Infected curve ####
S00;S01;S02
##### NUMBER OF INFECTED ####
rbind(I00, I01, I02) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  ggtitle("Epidemic Size")
##### EPIDEMIC LENGTH ####
rbind(I00, I01, I02) %>% 
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  facet_grid(~Scenario) +
  ggtitle(" Epidemic duration")
```

### Use of PPE by residents and staff

```{r}
#### 60% residents/ 90% staff
D03 <- ReadSims(paste0(p, "03/EC/"))
S03 <- PlotCycles(D03, var = "I", col = "red3")
I03 <- CycleSums(D03) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Staff priority')
### 90% residents/ 60% staff
D04 <- ReadSims(paste0(p, "04/EC/"))
S04 <- PlotCycles(D04, var = "I", col = "red3")
I04 <- CycleSums(D04) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Residents priority')


S03; S04
##### NUMBER OF INFECTED ####
rbind(I03, I04) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  ggtitle("Epidemic Size")
##### EPIDEMIC LENGTH ####
rbind(I03, I04) %>% 
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  scale_fill_manual(values = ColPal) +
  facet_grid(~Scenario) +
  ggtitle(" Epidemic duration")
```


## Frequency of testing

Scenarios:

```{r}
p <- "../../Data/SimsOut/Testing/"
D00 <- ReadSims(paste0(p, "00/EC/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '00')

D01 <- ReadSims(paste0(p, "01/EC/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '01')

D02 <- ReadSims(paste0(p, "02/EC/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '02')

S00; S01; S02

rbind(I00, I01, I02) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r, fill = Scenario)) +
  scale_fill_manual(values = ColPal) 

rbind(I00, I01, I02) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_H, fill = Scenario)) +
  scale_fill_manual(values = ColPal)  +
  ggtitle("Hospitalizations")

rbind(I00, I01, I02) %>% 
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  facet_grid(~Scenario) +
  scale_fill_manual(values = ColPal) 

# rbind(I00, I01, I02) %>%
#   mutate(HospRate = Cumulative_H/(Cumulative_I_r+Cumulative_I_s)) %>%
#   ggplot() +
#   geom_boxplot(aes(y = HospRate, fill = Scenario)) +
#   scale_fill_manual(values = ColPal)  +
#   ggtitle("Hospitalizations")
```


```{r}
rbind(I00, I01, I02) %>%
  group_by(Scenario) %>%
  summarise_at(.vars = c('I', 'day'), .funs = c(mean)) %>%
  mutate_at(.vars = c('I', 'day'), .funs = ~(.[1] - .)/.[1])
```

## Probability of introduction

```{r}
p <- "../../Data/SimsOut/Introduction/"
D00 <- ReadSims(paste0(p, "00/EC/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '00')

D01 <- ReadSims(paste0(p, "01/EC/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '01')

D02 <- ReadSims(paste0(p, "02/EC/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = '02')

S00; S01; S02

rbind(I00, I01, I02) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r, fill = Scenario)) +
  scale_fill_manual(values = ColPal) 

rbind(I00, I01, I02) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_H, fill = Scenario)) +
  scale_fill_manual(values = ColPal)  +
  ggtitle("Hospitalizations")

rbind(I00, I01, I02) %>% 
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  facet_grid(~Scenario) +
  scale_fill_manual(values = ColPal) 
```


## Vaccination


```{r}
p <- "../../Data/SimsOut/Vaccination/"
D00 <- ReadSims(paste0(p, "00/EC/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'No vaccination')

D01 <- ReadSims(paste0(p, "01/EC/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Staff Vaccination')

D02 <- ReadSims(paste0(p, "02/EC/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Resident Vaccination')

D03 <- ReadSims(paste0(p, "03/EC/"))
S03 <- PlotCycles(D03, var = "I", col = "red3")
I03 <- CycleSums(D03) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Staff+Resident Vaccination')

S00; S01; S02; S03

rbind(I00, I01, I02, I03) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_I_r, fill = Scenario)) +
  scale_fill_manual(values = ColPal) 

rbind(I00, I01, I02, I03) %>%
  ggplot() +
  geom_boxplot(aes(y = Cumulative_H, fill = Scenario)) +
  scale_fill_manual(values = ColPal)  +
  ggtitle("Hospitalizations")

rbind(I00, I01, I02, I03) %>% 
  ggplot() +
  geom_histogram(aes(day, fill = Scenario)) +
  facet_grid(~Scenario) +
  scale_fill_manual(values = ColPal) 
```




| Scenario | Testing Freq | PPE effect | PPE p Res | PPE p Staff |
| :------- | :----------- | :--------- | :-------- | :---------- |
| 00       | 7 days       | 0.80       | 90%       | 90%         |

Using ODEs to represent the immune response is very resource consuming, maybe we can use a simpler approach like a constant that varies depending on some tresholds (i.e. first dose, second dose, end of immune coverage, etc...)
```{r}
k <- 0.000004
Day <- 1:300

y <- x*k

y <- lapply(Day, function(x){
  # x <- Day[1]
  k <- ifelse(x < 10, 0.00001, 0.01)
  o <- ifelse(x > 120, (1-0.1), (1-0.000001))
  
  y <- (x^3*k*o)/1000
  y <- ifelse(y > 0.8, 0.8, y)
}) %>% unlist()


y[300]
plot(y~Day)
```
