---
title: "Simulation Outputs"
output: html_notebook
---

# Setup

```{r}
### Libraries
library(dplyr); library(ggplot2); library(ggpubr);library(Pabloverse); library(sf)
library(rpart); library(randomForest); library(caret)
#Total population
N <- 170 + 174
# ==============================================================================
# FUNCTIONS
# ==============================================================================
# Read Simulations
# ------------------------------------------------------------------------------
ReadSims <- function(dir){
  # dir = paste0(p, "00/EC/")
  f <- list.files(dir, full.names = TRUE)
  L <- lapply(1:length(f), function(x){
    read.csv(f[x], fileEncoding = 'UTF-8') %>% # read files
      mutate(Sim = x, day = ceiling(cycle/24)) %>% # create variable for sim number and day
      group_by(Sim, day) %>% # group by simulation and day
      summarise_all(.funs = max) %>%# get the max for all the records.
      ungroup()
    })
  
  N_sim <- lapply(L, nrow) %>% unlist() %>% max(.)
  
  L <- lapply(L, function(x){
    d <- N_sim - nrow(x)
      x %>%
        slice(c(1:nrow(.), rep(nrow(.), each = d))) %>%
        mutate(day = 1:n())
  })
  L %>%
    do.call(rbind, .)
}
# Functions for getting quantiles
# ------------------------------------------------------------------------------
Q05 <- function(sims) quantile(sims, 0.05)
Q25 <- function(sims) quantile(sims, 0.25)
Q75 <- function(sims) quantile(sims, 0.75)
Q95 <- function(sims) quantile(sims, 0.95)

# Function for summarizing the cycles
# ------------------------------------------------------------------------------
CycleSums <- function(sims){
  # sims = D00
  cycle_IQR <- sims %>%
    dplyr::select(-Sim) %>%
    group_by(day) %>%
    summarise_all(.funs = c(Median = median, Q25 = Q25, Q75 = Q75))
  
  cycle_TTE <- sims %>%
    group_by(Sim) %>%
    filter(I == max(I)) %>%
    filter(cycle == max(cycle)) %>%
    mutate(day = floor(cycle/24),
           Cumulative_I = Cumulative_I_r + Cumulative_I_s,
           InfectionRate = Cumulative_I/N) %>%
    distinct()
  
  return(list(cycle_IQR = cycle_IQR, cycle_TTE = cycle_TTE))
}

# Function for the plots
# ------------------------------------------------------------------------------
PlotCycles <- function(sims, var, col, y_lim){
  # sims = D00; var = "I"; col = "red3"
  # y_lab = ifelse(grepl("_P", var), "Infected \n pig herds", "Infected \n wild boar")
  p = sims %>%
    CycleSums() %>%
    .$cycle_IQR %>%
    ggplot(aes(x = day)) +
    geom_line(aes(y = eval(parse(text = paste0(var, '_Median')))),
      col = col, lwd = 1) +
    geom_ribbon(aes(
      ymin = eval(parse(text = paste0(var, '_Q25'))),
      ymax = eval(parse(text = paste0(var, '_Q75')))),
      alpha = 0.3, fill = col) +
    ylab("Number of Infected") +
    theme_minimal() 
    # ylab(y_lab) +
  #   xlab("Days") +
  #   theme(legend.position = "none",
  #     axis.title.y = element_text(angle = 0, vjust = 0.5))
  # if( !missing(y_lim) ) p = p + ylim(y_lim)
  p
  
}
#### Function for time to eradication ####
#----------------------------------------#
TE_data <- function(data){
  data %>%
    mutate(day = floor(cycle/24)) %>%
    group_by(Sim, day) %>%
    summarise(I = max(I)) %>%
    group_by(Sim) %>%
    filter(I == max(I)) %>%
    filter(day == min(day))
}

#### Plot the outputs ####
#-------------------------------#
Plots <- function(x, main = ''){
  ##### NUMBER OF INFECTED ####
  CumI_p <- x %>%
  ggplot() +
  geom_boxplot(aes(y = InfectionRate, fill = Scenario), alpha = 0.6) +
  scale_fill_manual(values = ColPal) +
  ylab("Infection rate") +
  ggtitle("Epidemic Size") +
    theme_minimal() +
    theme(axis.text.x = element_blank())
  ##### EPIDEMIC LENGTH ####
  EpiL_p <- x %>% 
    ggplot() +
  geom_histogram(aes(day, fill = Scenario, col = Scenario), alpha = 0.4, binwidth = 5) +
  scale_fill_manual(values = ColPal) +
    scale_color_manual(values = ColPal) +
  facet_grid(~Scenario) +
  ggtitle(" Epidemic duration") +
    theme_minimal()

  if(length(unique(x$Scenario)) == 1){
    ggarrange(CumI_p, EpiL_p, ncol = 2, common.legend = T) %>%
      annotate_figure(text_grob(main, color = "grey20", face = "bold", size = 14)) 
  }else{
    ggarrange(CumI_p, EpiL_p, nrow = 2, common.legend = T) %>%
      annotate_figure(text_grob(main, color = "grey20", face = "bold", size = 14)) 
  }
}

#### Summary table ####
#-------------------------------#
Sum_Tbl <- function(x){
  x %>%
    group_by(Scenario) %>%
    summarise_at(.vars = c('InfectionRate', 'day', 'Cumulative_I', 'Cumulative_I_r', 'Cumulative_I_s', 'Cumulative_H', 'D'), .funs = c(m = median, Q05 = Q05, Q95 = Q95)) %>%
    mutate(across(where(is.numeric), ~round(., 2)),
           InfectionRate = paste0(InfectionRate_m, ' (', InfectionRate_Q05, ',', InfectionRate_Q95, ')'),
           day = paste0(day_m, ' (', day_Q05, ',', day_Q95, ')'),
           Cumulative_I = paste0(Cumulative_I_m, ' (', Cumulative_I_Q05, ',', Cumulative_I_Q95, ')'),
           Cumulative_I_r = paste0(Cumulative_I_r_m, ' (', Cumulative_I_r_Q05, ',', Cumulative_I_r_Q95, ')'),
           Cumulative_I_s = paste0(Cumulative_I_s_m, ' (', Cumulative_I_s_Q05, ',', Cumulative_I_s_Q95, ')'),
           Cumulative_H = paste0(Cumulative_H_m, ' (', Cumulative_H_Q05, ',', Cumulative_H_Q95, ')'),
           Cumulative_D = paste0(D_m, ' (', D_Q05, ',', D_Q95, ')')) %>%
    select(Scenario, day, InfectionRate, Cumulative_I, Cumulative_I_r, Cumulative_I_s, Cumulative_H, Cumulative_D)
}
```


# Test
```{r Test}
p <- "../../Data/SimsOut/Test/"
ColPal <- c("grey40")
### Test
Bb <- ReadSims(p)
Sb <- PlotCycles(Bb, var = "I", col = "red3")
Ib <- CycleSums(Bb) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Baseline')

BTbl <- Sum_Tbl(Ib)
Plots(Ib, 'Baseline Scenario')
Sb
BTbl
```


# Baseline

```{r}
p <- "../../Data/SimsOut/Baseline/"
ColPal <- c("grey40")
### Baseline
Bb <- ReadSims(p)
BIp <- PlotCycles(Bb, var = "I", col = "red3")
BCIp <- Bb %>%
  mutate(CumI = Cumulative_I_r + Cumulative_I_s) %>% 
  PlotCycles(., var = 'CumI', col = 'red3')

Ib <- CycleSums(Bb) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Baseline')

BTbl <- Sum_Tbl(Ib)
Plots(Ib, 'Baseline Scenario') %>%
  ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/Baseline.png", width = 8, height = 4)
BIp; BCIp
BTbl
```



# Sensitivity analysis
## Transmission probability

00 - 0.50
01 - 0.52
02 - 0.55

```{r Transmission}
p <- "../../Data/SimsOut/SensitivityAnalysis/TransmissionProbability/"
ColPal <- c("#B284E3", "grey40", "#F28C8C")
### 3% Transmission Probability
D00 <- ReadSims(paste0(p, "Low/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Low transmission')
### 7% Introduction Probability
D01 <- ReadSims(paste0(p, "High/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'High transmission')
# ### 10% Introduction Probability
# D02 <- ReadSims(paste0(p, "02/"))
# S02 <- PlotCycles(D02, var = "I", col = "red3")
# I02 <- CycleSums(D02) %>%
#   .$cycle_TTE %>%
#   mutate(Scenario = 'High transmission')

x <- rbind(I00, Ib, I01) %>%
  mutate(Scenario = factor(Scenario, levels = c('Low transmission', 'Baseline', 'High transmission'))) 

TTbl <- Sum_Tbl(x)
x %>%
  Plots('Transmission Probability') %>%
  ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/Transmission.png", width = 9, height = 5)
TTbl
```


## Introduction probability

00 - 0.05
01 - 0.1
02 - 0.15

```{r Introduction}
p <- "../../Data/SimsOut/SensitivityAnalysis/IntroductionProbability/"
ColPal <- c("#704500", 'grey40', "#076600")
### 1% Introduction Probability
D00 <- ReadSims(paste0(p, "Low/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Low Introduction Probability')
### 10% Introduction Probability
D01 <- ReadSims(paste0(p, "High/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'High Introduction Probability')
### 10% Introduction Probability
# D02 <- ReadSims(paste0(p, "02/"))
# S02 <- PlotCycles(D02, var = "I", col = "red3")
# I02 <- CycleSums(D02) %>%
#   .$cycle_TTE %>%
#   mutate(Scenario = '10% Introduction Probability')

x <- rbind(I00, Ib, I01) %>%
  mutate(Scenario = factor(Scenario, levels = c('Low Introduction Probability', 'Baseline', 'High Introduction Probability'))) 

ITbl <- Sum_Tbl(x)

x %>%
  Plots(main = "Probability of Introduction")  %>%
  ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/Introduction.png", width = 9, height = 5)
ITbl
```

## Detection probability

00 - 75% detection probability
01 - 80% detection probability
02 - 90% Detection probability

```{r DetectionProbability SA}
p <- "../../Data/SimsOut/SensitivityAnalysis/DetectionProbability/"
ColPal <- c("#00827E", 'grey40', "#00CFB7")
### 75% Detection Probability
D00 <- ReadSims(paste0(p, "Low/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Low Detection Probability')
## 85% Detection Probability
D01 <- ReadSims(paste0(p, "High/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'High Detection Probability')


x <- rbind(I00, Ib, I01) %>%
  mutate(Scenario = factor(Scenario, levels = c('Low Detection Probability', 'Baseline', 'High Detection Probability')))

DTbl <- Sum_Tbl(x)
x %>%
  Plots(main = "Probability of Detection") %>%
  ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/ProbDetection.png", width = 9, height = 5)
DTbl
```


## PPE Effect

00 - LB
01 - Estimate
02 - UB (0.2408)

```{r FaceMasks}
p <- "../../Data/SimsOut/SensitivityAnalysis/FaceMasks/"
ColPal <- c("#5C9669", "#6A918C", "#7280B3")
### 1% Introduction Probability
D00 <- ReadSims(paste0(p, "High/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'High effect PPE')
### 5% Introduction Probability
D01 <- ReadSims(paste0(p, "Low/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Low effect PPE')

x <- rbind(I00, Ib, I01) %>%
  mutate(Scenario = factor(Scenario, levels = c('High effect PPE', 'Baseline', 'Low effect PPE'))) 

PPETbl <- Sum_Tbl(x)
x %>% 
  Plots('Effect of PPE') %>%
  ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/PPE.png", width = 9, height = 5)
PPETbl
```


## Testing Frequency ()

```{r}
p <- "../../Data/SimsOut/SensitivityAnalysis/TestingFreq/"
ColPal <- c("#5C9669", "#6A918C", "#7280B3")
### 1% Introduction Probability
D00 <- ReadSims(paste0(p, "Testing5/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Every 5 days')
### 5% Introduction Probability
D01 <- ReadSims(paste0(p, "Testing3/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Every 3 days')

x <- rbind(I00, Ib, I01) %>%
  mutate(Scenario = factor(Scenario, levels = c('Baseline', 'Every 5 days', 'Every 3 days'))) 

TFTbl <- Sum_Tbl(x)
TFTbl
x %>% 
  Plots('Testing Frequency') %>%
  ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/TestingFreq.png", width = 9, height = 5)
```


## Vaccine Effect

```{r}
p <- "../../Data/SimsOut/SensitivityAnalysis/VaccineEffect/"

ColPal <- c("#5C9669", "#6A918C", "#7280B3")
### Same vaccine effect for residents and staff
D00 <- ReadSims(paste0(p, "Equal/"))
S00 <- PlotCycles(D00, var = "I", col = "red3")
I00 <- CycleSums(D00) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Same vaccine effect')
### Different vaccine effect for residents and staff (Pfizer)
D01 <- ReadSims(paste0(p, "Pfizer/"))
S01 <- PlotCycles(D01, var = "I", col = "red3")
I01 <- CycleSums(D01) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Pfizer')
### Different vaccine effect for residents and staff (Pfizer)
D02 <- ReadSims(paste0(p, "Moderna/"))
S02 <- PlotCycles(D02, var = "I", col = "red3")
I02 <- CycleSums(D02) %>%
  .$cycle_TTE %>%
  mutate(Scenario = 'Moderna')

x <- rbind(I00, I01, I02) %>%
  mutate(Scenario = factor(Scenario, levels = c('Same vaccine effect', 'Pfizer', 'Moderna'))) 

VeTbl <- Sum_Tbl(x)

x %>%
  Plots('Vaccine Effect') %>%
  ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/VaccinationEf.png", width = 9, height = 5)
VeTbl
```


### Summary 

```{r SA Summary}
rbind(BTbl, TTbl, ITbl, DTbl, PPETbl, TFTbl, VeTbl) %>%
  distinct() %>%
write.csv(., "../../Documentation/Tables/SA_sum.csv", row.names = F)
```




# Scenario Modeling

## Function for plots
```{r}
PlotScenarios <- function(x, v, main){
  CumI_p <- x %>%
  ggplot() +
  geom_boxplot(aes(y = InfectionRate, fill = eval(parse(text=v))), alpha = 0.6) +
  scale_fill_manual(values = ColPal) +
  facet_wrap(~cl) +
  theme_minimal()+
  theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.background = element_rect(colour="black",
                                        fill="grey90")) +
    ylab("Proportion of Infected") +
    labs(fill = v)

  EpiL_p <- x %>%
    ggplot() +
    geom_histogram(aes(day, fill = eval(parse(text=v)), color = eval(parse(text=v))),
                   alpha = 0.6,
                   binwidth = 5) +
    scale_fill_manual(values = ColPal) +
    scale_color_manual(values = ColPal) +
    facet_wrap( ~ cl + eval(parse(text=v)), nrow = 1) +
    ggtitle(" Epidemic duration") +
    theme_minimal() +
    theme(strip.background = element_blank(), strip.text = element_blank()) +
    labs(fill = v)
  
  ggarrange(CumI_p, EpiL_p, nrow = 2, common.legend = T) %>%
    annotate_figure(text_grob(
      main,
      color = "grey20",
      face = "bold",
      size = 14
    ))
}

```


## Testing Frequency

```{r}
ColPal <- c("#C70704", "#BAB700", "#008C0C")
p <- "../../Data/SimsOut/Scenarios/TF/"
d <- list.files(p)
DL <- lapply(paste0(p,d), function(x){
  D <- ReadSims(x) %>%
    CycleSums(.) %>%
    .$cycle_TTE %>%
    mutate(Scenario = factor(gsub(p, '', x), levels = c('HI_7', 'HI_5', 'HI_3', 'MI_7', 'MI_5', 'MI_3', 'LI_7', 'LI_5', 'LI_3')))
}) %>%
  do.call(rbind,.) %>% 
  mutate(cl = factor(gsub('_.*', '', Scenario), levels = c('HI', 'MI', 'LI')),
         cl = recode(cl, HI = 'High', MI = 'Medium', LI = 'Low'),
    TestingInterval = factor(gsub('.*_', '', Scenario), levels = c('7', '5', '3')),
    TestingInterval = recode(TestingInterval, `7` = '7 Days', `5` = '5 Days', `3` = '3 Days'))


PlotScenarios(x = DL, v = 'TestingInterval', main = "Testing Interval") %>%
  ggsave(filename = "../../Documentation/Figures/Scenarios/TF.png", width = 9, height = 6)
Sum_Tbl(DL)  %>%
  write.csv(., "../../Documentation/Tables/TF.csv", row.names = F)
```


## Vaccine Effect

```{r}
ColPal <- c("#5C9669", "#6A918C", "#7280B3")
p <- "../../Data/SimsOut/Scenarios/VE/"
d <- list.files(p)
DL <- lapply(paste0(p,d), function(x){
  D <- ReadSims(x) %>%
    CycleSums(.) %>%
    .$cycle_TTE %>%
    mutate(Scenario = factor(gsub(p, '', x), levels = c('HI_E', 'HI_P', 'HI_M', 'MI_E', 'MI_P', 'MI_M', 'LI_E', 'LI_P', 'LI_M')))
}) %>%
  do.call(rbind,.) %>% 
  mutate(cl = factor(gsub('_.*', '', Scenario), levels = c('HI', 'MI', 'LI')),
         cl = recode(cl, HI = 'High', MI = 'Medium', LI = 'Low'),
    VaccineEffect = factor(gsub('.*_', '', Scenario), levels = c('E', 'P', 'M')))


PlotScenarios(x = DL, v = 'VaccineEffect', main = "Vaccine Effect") %>%
  ggsave(filename = "../../Documentation/Figures/Scenarios/VE.png", width = 9, height = 6)
Sum_Tbl(DL) %>%
  write.csv(., "../../Documentation/Tables/VE.csv", row.names = F)
```

## Vaccine Distribution

```{r}
ColPal <- c("#414042", "#8C8700", "#5D0DB3")
p <- "../../Data/SimsOut/Scenarios/VD/"
d <- list.files(p)
DL <- lapply(paste0(p,d), function(x){
  D <- ReadSims(x) %>%
    CycleSums(.) %>%
    .$cycle_TTE %>%
    mutate(Scenario = factor(gsub(p, '', x), levels = c('HI_E', 'HI_R', 'HI_S', 'MI_E', 'MI_R', 'MI_S', 'LI_E', 'LI_R', 'LI_S')))
}) %>%
  do.call(rbind,.) %>% 
  mutate(cl = factor(gsub('_.*', '', Scenario), levels = c('HI', 'MI', 'LI')),
         cl = recode(cl, HI = 'High', MI = 'Medium', LI = 'Low'),
    VaccineDistribution = factor(gsub('.*_', '', Scenario), levels = c('E', 'R', 'S')),
    VaccineDistribution = recode(VaccineDistribution, E = 'Equal Distribution', R = 'Resident Priority', S = 'Staff Priority'))

PlotScenarios(x = DL, v = 'VaccineDistribution', main = "Vaccine Distribution") %>%
  ggsave(filename = "../../Documentation/Figures/Scenarios/VD.png", width = 9, height = 6)
Sum_Tbl(DL) %>%
  write.csv(., "../../Documentation/Tables/VD.csv", row.names = F)
```

```{r}
Sum_Tbl(DL)
```

# Version 2

```{r Functions}
###### For READING FILES ########
# Function to read the sims
# ---------------------------------------
ReadSims <- function(d) {
  f <- list.files(d, full.names = T)
  D <- lapply(f, function(x) {
    read.csv(x)
  }) %>%
    do.call(rbind, .)
  return(D)
}
# Function to read the directories
# ------------------------------------
ReadDirs <- function(d){
  dirs <- list.dirs(d, recursive = F)
  Ld <- lapply(dirs, ReadSims)
  names(Ld) <- gsub(d, '', dirs) %>%  gsub('([^A-z])', '', .)
  return(Ld)
}
# Function for tables
# -----------------------------------
SumTbl <- function(d){
  d %>% 
    summarise_at(.vars = c('AtkRate', 'Cumulative_I', 'Cumulative_I_r', 'Cumulative_I_s', 'Cumulative_H', 'D', 'LastInfection'),
                 .funs = c('mean' =  ~round(wilcox.test(., conf.int = T)$estimate, 2),
                           'q05' = ~round(wilcox.test(., conf.int = T)$conf.int[1], 2),
                           'q95' = ~round(wilcox.test(., conf.int = T)$conf.int[2], 2))) %>% 
    data.frame() %>% 
  mutate(LastInfection = paste0(LastInfection_mean, ' (', LastInfection_q05, ', ', LastInfection_q95, ')'),
         AtkRate = paste0(AtkRate_mean, ' (', AtkRate_q05, ', ', AtkRate_q95, ')'),
         Cumulative_I = paste0(Cumulative_I_mean, ' (', Cumulative_I_q05, ', ', Cumulative_I_q95, ')'),
         Cumulative_I_r = paste0(Cumulative_I_r_mean, ' (', Cumulative_I_r_q05, ', ', Cumulative_I_r_q95, ')'),
         Cumulative_I_s = paste0(Cumulative_I_s_mean, ' (', Cumulative_I_s_q05, ', ', Cumulative_I_s_q95, ')'),
         Cumulative_H = paste0(Cumulative_H_mean, ' (', Cumulative_H_q05, ', ', Cumulative_H_q95, ')'),
         D = paste0(D_mean, ' (', D_q05, ', ', D_q95, ')')
         )
}

Tbl <- function(d, x){
  d %>% 
    group_by(seed) %>%
    slice(n()) %>%
    group_by({{x}}) %>%
    SumTbl() %>%
    select({{x}}, LastInfection:D) 
}
# Function to get the plots 
# ----------------------------------
RFCART <- function(data, f, main = '', seed = 1, palette  ='-RdYlGn'){
  PL <- list()
  
  set.seed(seed)
  # Split the data train/test
  ind <- sample(2, nrow(data), replace = TRUE, prob = c(0.7, 0.3))
  train <- data[ind==1,]
  test <- data[ind==2,]
  # Random Forest model fit
  rf <- randomForest::randomForest(f, data=train, proximity=TRUE) 
  print(rf)
  
  # Variable importance
  PL[[2]] <- importance(rf) %>%
    data.frame() %>% 
    mutate(variable = rownames(.), RelImpt = IncNodePurity/sum(IncNodePurity)) %>%
    ggplot(aes(x = reorder(variable, RelImpt), y = RelImpt)) +
    geom_col() +
    coord_flip() +
    labs(x = '', y = 'Relative Importance', title = main) +
    theme_minimal() +
    theme(axis.text=element_text(size=14),
        axis.title=element_text(size=16,face="bold"))
  
  # tr <- tree::tree(f, data=data)
  # plot(tr); text(tr)
  fit <- rpart(f, data=data, method = 'anova')
  PL[[1]] <- rpart.plot::rpart.plot(fit, type = 4, box.palette = palette, branch.lty = 2)
  
  return(PL)
}
ICurveP <- function(x){
  d$EC %>% 
    mutate(day = floor(cycle/24)) %>%
    # group_by(seed) %>% 
    # mutate(L = n()) %>% ungroup() %>% mutate(mL = max(L), dL = mL - L) %>%  group_by(seed) %>% slice(c(1:n(),rep(n(), max(dL)))) %>% 
    # ungroup() %>% arrange(seed, day) %>% 
    group_by(day, {{x}}) %>% 
    summarise(MeanCI = mean(Cumulative_I), MedianCI = median(I)) %>% 
   ggplot() +
  geom_line(aes(day, MeanCI, col = factor({{x}})), lwd = 0.5) +
  Pabloverse::Theme1()
}

BoxPlot <- function(d, x, y, ColPal = 1:5) {
  d %>%
    group_by(seed, {{y}}) %>%
    filter(cycle == max(cycle)) %>%
    ggplot() +
    geom_boxplot(aes({{x}}, fill = {{y}}), alpha = 0.8, col = 'black') +
    coord_flip() +
    scale_fill_manual(values = ColPal)
}
```

## Load the data

```{r load the data}
#Total population
N <- 170 + 174
p <- "../GAMA_NHCOVID/NH_COVID/models/results/GSA/"
d <- ReadDirs(p)
Outcomes <- c('I', 'Cumulative_I', 'I_r', 'I_s', 'Introductions', 'PassiveDet_s', 'ActiveDet_s', 'PassiveDet_r', 'ActiveDet_r')
Var <- c('GlobalShedding_p', 'AsymptTransmission', 'Introduction_p', 'TestingFreq', 'detection_p', 'SR_OR', 'PPE_OR',  'vaccination_dist', 'VaccineEff')

d$EC <- d$EC %>% 
  mutate(Cumulative_I = Cumulative_I_r + Cumulative_I_s, AtkRate = Cumulative_I / N, 
         LastInfection = (LastInfection/24) + 0, # Add days of sickness (in average, fix this later in the model)
         detection_p = Test_sensitivity) %>% 
  mutate_at(Var, factor) %>%
  mutate(Introduction_p = recode(as.character(Introduction_p), `0.01` = 'Low', `0.05` = 'Medium', `0.1` = 'High')) %>% 
  # mutate(Introduction_p = recode(as.character(Introduction_p), `0.04` = 'Low', `0.05` = 'Medium', `0.06` = 'High'),
  #        Introduction_p = factor(Introduction_p, levels = c('Low', 'Medium', 'High'))) %>% 
  data.frame()

d$Cum <- d$EC %>% 
  group_by(seed) %>% 
  slice(n()) %>% 
  data.frame()

unique(d$EC$TestingFreq)
d$Cum %>% count(Introduction_p)

d$ECo <- d$EC %>% 
  group_by(seed) %>% 
  mutate(T_I_r = max(Cumulative_I_r)) %>% 
  data.frame() %>% 
  filter(T_I_r > 1)


# How long did it took to run? (in minutes, must be from continuous runs)
d$EC %>% 
  group_by(seed) %>% 
  summarise(t = (max(t) - min(t))/(1000*60)) %>% 
  pull(t) %>% 
  mean()
nrow(d$Cum)
```

### Corplot 

```{r}
ds <- d$Cum %>% 
  select(c(Outcomes, Var)) %>%
  mutate_all(~as.numeric(as.factor(.)))
  
  # count(seed, .dots=lapply(c(Outcomes, Var), as.symbol)) %>% 
  # select(-seed, -n) %>% 
  # mutate_all(~as.numeric(as.factor(.)))
ds %>% 
  # count(TestingFreq, PPE_OR)
  # count(TestingFreq, Introduction_p)
  count(detection_p, PPE_OR)
  # count(AsymptTransmission, Introduction_p)

corrplot::corrplot(cor(ds))
```



```{r Observed data}
# Load and filter the CMS data
CMS_CA <- read.csv("../../Data/CMS/COVID-19_Nursing_Home_Dataset.csv") %>%
  mutate(date = as.Date(Week.Ending, format = '%m/%d/%Y')) %>% 
  filter(Provider.State == "CA")

range(CMS_CA$date)

# Format the data:
CMSCA_ts <- CMS_CA %>% replace(is.na(.), 0) %>%
  select(date, Provider = Federal.Provider.Number, Ir = Residents.Weekly.Confirmed.COVID.19, Is = Staff.Weekly.Confirmed.COVID.19, Dr = Residents.Weekly.COVID.19.Deaths, OccBeds = Total.Number.of.Occupied.Beds) %>%
  arrange(Provider, date) %>%
  group_by(Provider) %>%
  mutate_at(.vars = c('Ir', 'Is', 'Dr'), .funs = c('cumsum', 'sum')) %>%
  mutate(CumI = Ir_cumsum + Is_cumsum,
         TotalI = Ir_sum + Is_sum) %>%
  filter(CumI > 0) %>%
  mutate(OccBeds = max(OccBeds), 
         d = date - first(date), 
         p_infection = Ir_sum/OccBeds, 
         I = Ir + Is) %>%
  filter(between(OccBeds, 160, 200),
         TotalI != CumI)

Obs <- CMSCA_ts %>% data.frame() %>%
  filter(d < 150) %>%
  mutate(day = d, type = "observed") %>%
  select(day, CumI, type, Ir_cumsum, Is_cumsum, Sim = Provider)

# Data from interviewed NH
CVS <- CMS_CA %>%
  filter(Provider.Name == 'CLEAR VIEW SANITARIUM') %>%
  arrange(date) %>%
  filter(Residents.Total.Confirmed.COVID.19 > 0) %>% 
  mutate(I = Residents.Total.Confirmed.COVID.19 + Staff.Total.Confirmed.COVID.19) %>%
  select(Provider = Federal.Provider.Number, I, date, Ir_cumsum = Residents.Total.Confirmed.COVID.19, IS_cumsum = Staff.Total.Confirmed.COVID.19) %>% 
  mutate(day = (date - first(date)) + 7)

Obs_s <- Obs %>% 
  group_by(day, type) %>% 
  summarise_at(.vars = c('CumI', 'Ir_cumsum', 'Is_cumsum'), 
               .funs = c(m = ~quantile(., 0.5), q05 = ~quantile(., 0.25), q95 = ~quantile(., 0.75)))%>% 
  mutate(day = as.numeric(day))
```

## Observed vs sim

```{r}
unique(d$EC$GlobalShedding_p)
unique(d$EC$vaccination_dist)
unique(d$EC$PPE_OR)

B <- d$EC %>% 
  filter(TestingFreq == 7) %>%
  filter(Introduction_p == "Medium") %>%
  filter(vaccination_dist == 0) %>%
  # filter(detection_p == 0.8) %>%
  filter(PPE_OR == 0.1467) %>%
  filter(GlobalShedding_p %in% c(0.38, 0.38*1.2)) %>%
  # filter(TestingFreq == 7, vaccination_dist == 0, GlobalShedding_p == 0.35) %>%
  data.frame()

Exp <- B %>%
  mutate(day = cycle/24, CumI = Cumulative_I_r + Cumulative_I_s, type = "simulated") %>% 
  # Repeat the last row 150 times
  group_by(seed) %>%
  mutate(tMinus = 150 - max(day)) %>%
  slice(c(1:n(), rep(n(), 150))) %>%
  mutate(day = 1:n()) %>%  # Change the day number in order
  slice(1:150) %>% # select the first 150 of each group (seed)
  select(day,LastInfection,  CumI, type, Ir_cumsum = Cumulative_I_r, Is_cumsum = Cumulative_I_s, Sim = seed, Introductions) %>% 
  group_by(day, type) 

Exp_s <- Exp %>% 
  summarise_at(.vars = c('LastInfection', 'CumI', 'Ir_cumsum', 'Is_cumsum', 'Introductions'), 
               .funs = c(m = ~quantile(., 0.5), q05 = ~quantile(., 0.05), q95 = ~quantile(., 0.95))
               )

Ob_Ex <- rbind(Obs_s, Exp_s)
OEp <- list()

B %>%
  group_by(seed) %>% 
  slice(n())

B %>% mutate(i = 1) %>% Tbl(., i)

OEp[[1]] <- Ob_Ex %>% 
  ggplot(aes(x = day)) +
  geom_ribbon(aes(ymin = Is_cumsum_q05, ymax = Is_cumsum_q95, fill = type, col = type), alpha = 0.15) +
  geom_line(aes(y = Is_cumsum_m, col = type), lwd = 1, alpha = 0.8) +
  geom_point(data = CVS, aes(y = IS_cumsum, alpha = ''), shape = 18, size = 2.5, col = 'black') +
  scale_color_manual(values = c('red3', "blue3")) +
  scale_fill_manual(values = c('red2', "blue2")) +
  theme_minimal() +
  scale_alpha_manual(values = 1) +
  labs(title = 'Staff', y = 'Median', x = 'Day', alpha = 'LCF Interviewed') +
  xlim(c(0, 150))

OEp[[2]] <- Ob_Ex %>% 
  ggplot(aes(x = day)) +
  geom_ribbon(aes(ymin = Ir_cumsum_q05, ymax = Ir_cumsum_q95, fill = type, col = type), alpha = 0.15) +
  geom_line(aes(y = Ir_cumsum_m, col = type), lwd = 1, alpha = 0.8) +
  geom_point(data = CVS, aes(y = Ir_cumsum, alpha = ''), shape = 18, size = 2.5, col = 'black') +
  scale_color_manual(values = c('red3', "blue3")) +
  scale_fill_manual(values = c('red2', "blue2")) +
  theme_minimal() +
  scale_alpha_manual(values = 1) +
  labs(title = 'Residents', y = 'Median', x = 'Day', alpha = 'LCF Interviewed') +
  xlim(c(0, 150))

ggarrange(plotlist = OEp, common.legend = T) %>% 
  annotate_figure(top = "Observed vs simulated outbreaks") 
# %>% 
  # ggsave(filename = '../../Documentation/Figures/V2/ObsExp.png', width = 8, height = 4.5)
```


```{r}
# Correlation and R^2
dm <- rbind(Obs, Exp[-c(2, 8)]) %>%
  group_by(day, type) %>%
  summarise_at(.vars = c('CumI', 'Ir_cumsum', 'Is_cumsum'), .funs = median) %>%
  arrange(type) %>%
  data.frame()

odays <- dm %>%
  filter(type == 'observed') %>%
  pull(day)

dms <- dm %>%
  filter(day %in% odays, 
         day != 0) %>%
  split(.$type)

#Correlation
pIt <- cor(dms$observed$CumI, dms$simulated$CumI)
pIr <- cor(dms$observed$Ir_cumsum, dms$simulated$Ir_cumsum)
pIs <- cor(dms$observed$Is_cumsum, dms$simulated$Is_cumsum)

R2t <- lm(dms$observed$CumI~dms$simulated$CumI) %>%
  summary() %>%
  .$r.squared

R2r <- lm(dms$observed$Ir_cumsum~dms$simulated$Ir_cumsum) %>%
  summary() %>%
  .$r.squared

R2s <- lm(dms$observed$Is_cumsum~dms$simulated$Is_cumsum) %>%
  summary() %>%
  .$r.squared
```


## Overview


```{r overall outbreak size}
d$EC %>% 
  group_by(seed) %>% 
  filter(cycle == max(cycle)) %>% 
  ggplot() +
  geom_histogram(aes(AtkRate))

nvd <- d$EC %>% filter(vaccination_dist == 0.0, PPE_OR == 0.1467)

BoxPlot(d = d$EC, x = AtkRate, y = GlobalShedding_p)
Tbl(d = d$EC, x = GlobalShedding_p)
BoxPlot(d = d$EC, x = AtkRate, y = Introduction_p)
Tbl(d = d$EC, x = Introduction_p)
BoxPlot(d = d$EC, x = AtkRate, y = detection_p)
Tbl(d = d$EC, x = detection_p)
BoxPlot(d = d$EC, x = AtkRate, y = PPE_OR)
Tbl(d = d$EC, x = PPE_OR)
BoxPlot(d = d$EC, x = AtkRate, y = AsymptTransmission)
Tbl(d = d$EC, x = AsymptTransmission)
BoxPlot(d = d$EC, x = AtkRate, y = vaccination_dist)
Tbl(d = d$EC, x = vaccination_dist)
BoxPlot(d = nvd, x = AtkRate, y = TestingFreq)
Tbl(d = nvd, x = TestingFreq)
BoxPlot(d = d$EC, x = AtkRate, y = SR_OR)
Tbl(d = d$EC, x = SR_OR)

BoxPlot(d = d$EC %>% filter(vaccination_dist != 0), x = AtkRate, y = VaccineEff)
Tbl(d = d$EC, x = VaccineEff)
```

### ~Experimental function~

```{r}
f <- 'LastInfection~GlobalShedding_p'
LmCI <- function(d, f, a = 0.05) {
  # fit the model
  m <- d %>%
    lm(f, data = .)
  # obtain coefficients and CI
  coef <- round(m$coefficients, 2) # coefficients
  ci <- round(confint(m), 2) # CI
  p <- broom::glance(m)$p.value
  sig <- ifelse(p < a, '$^*$', '')
  # Paste it in a string
  est <- paste0(coef, '(', ci[,1], ',', ci[,2], ')', sig)
  names(est) <- names(coef)
  # data.frame(Var = names(coef), est) %>% 
    return(est)
}

Outcomes <- c('LastInfection', 'AtkRate', 'Cumulative_I', 'Cumulative_I_r', 'Cumulative_I_s', 'Cumulative_H', 'D')

Vs <- c('GlobalShedding_p', 'Introduction_p', 'detection_p', 'PPE_OR', 'AsymptTransmission', 'SR_OR')
# , 'vaccination_dist', , )
Ut <- list()
Ut[[1]] <- lapply(Vs, function(y){
  lapply(Outcomes, function(x){
  LmCI(d = d$Cum %>% 
         mutate_at(Vs, .funs = ~relevel(factor(.), 2)) %>% 
         mutate(Introduction_p = relevel(Introduction_p, 'Medium'),
                TestingFreq = relevel(TestingFreq, '7'),
                SR_OR = relevel(SR_OR, '1')) %>% 
         filter(., vaccination_dist == 0), f = paste0(x, '~', y))
}) %>% 
  do.call(cbind, .) %>% 
  data.frame() %>% `names<-`(Outcomes)
}) %>% 
  do.call(rbind, .) 

Ut[[2]] <- lapply(Outcomes, function(x){
  LmCI(d = d$Cum  %>%
         mutate(TestingFreq = relevel(TestingFreq, '7')) %>%
         filter(PPE_OR == 0.1467) %>%
         filter(., vaccination_dist == 0),
       f = paste0(x, '~', 'TestingFreq'))
}) %>% 
  do.call(cbind, .) %>% 
  data.frame() %>% `names<-`(Outcomes)

# Vaccine distribution
Ut[[3]] <- lapply(Outcomes, function(x){
  LmCI(d = d$Cum  %>%
         mutate(vaccination_dist = relevel(vaccination_dist, '0'))
       , f = paste0(x, '~', 'vaccination_dist'))
}) %>% 
  do.call(cbind, .) %>% 
  data.frame() %>% `names<-`(Outcomes)
# Vaccine efficacy
Ut[[4]] <- lapply(Outcomes, function(x){
  LmCI(d = d$Cum  %>%
         filter(vaccination_dist != 0) %>% 
         mutate(VaccineEff = relevel(VaccineEff, 'Equal'))
       , f = paste0(x, '~', 'VaccineEff'))
}) %>% 
  do.call(cbind, .) %>% 
  data.frame() %>% `names<-`(Outcomes)

Ut %>% 
  do.call(rbind, .) %>% 
  write.csv('../../Documentation/Tables/Univ.csv', quote = F, sep = '&')

# Get difference and CI
# make a linear regression
# obtain the estimate and CI
# report in a table
# join with the reference
```

```{r}
d$Cum %>% 
  filter(GlobalShedding_p == 0.304) %>% 
  group_by(i = 1) %>% 
  summarise_at(Outcomes, .funs = ~mean(.))
```


```{r}
SumTbl <- function(d){
  d %>% 
    summarise_at(.vars = c('AtkRate', 'Cumulative_I', 'Cumulative_I_r', 'Cumulative_I_s', 'Cumulative_H', 'D', 'LastInfection'),
                 .funs = c('mean' = ~round(mean(.), 2),
                           'q05' = ~round(wilcox.test(., conf.int = T)$conf.int[1], 2),
                           'q95' = ~round(wilcox.test(., conf.int = T)$conf.int[2], 2))) %>% 
    data.frame() %>% 
  mutate(LastInfection = paste0(LastInfection_mean, ' (', LastInfection_q05, ', ', LastInfection_q95, ')'),
         AtkRate = paste0(AtkRate_mean, ' (', AtkRate_q05, ', ', AtkRate_q95, ')'),
         Cumulative_I = paste0(Cumulative_I_mean, ' (', Cumulative_I_q05, ', ', Cumulative_I_q95, ')'),
         Cumulative_I_r = paste0(Cumulative_I_r_mean, ' (', Cumulative_I_r_q05, ', ', Cumulative_I_r_q95, ')'),
         Cumulative_I_s = paste0(Cumulative_I_s_mean, ' (', Cumulative_I_s_q05, ', ', Cumulative_I_s_q95, ')'),
         Cumulative_H = paste0(Cumulative_H_mean, ' (', Cumulative_H_q05, ', ', Cumulative_H_q95, ')'),
         D = paste0(D_mean, ' (', D_q05, ', ', D_q95, ')')
         )
}

Tbl <- function(d, x){
  d %>% 
    group_by(seed) %>%
    slice(n()) %>%
    group_by({{x}}) %>%
    SumTbl() %>%
    select({{x}}, LastInfection:D) 
}

# -----------------------
SigTest <- function()
Tbl(d = d$EC, x = GlobalShedding_p)

df <- d$EC %>% 
  mutate_at(Var, .funs = ~relevel(., 2)) %>% 
  # get the max cycle
  group_by(seed) %>% 
  slice(n()) %>% 
  data.frame()

v <- c('LastInfection', 'AtkRate', 'Cumulative_I', 'Cumulative_I_r', 'Cumulative_I_s', 'Cumulative_H', 'D')

Sigtest <- function(df, var) {
  lapply(v, function(x, ...) {
    test <-
      lm(formula = eval(parse(text = x)) ~ eval(parse(text = var)),
         data = df) %>%
      summary() %>%
      .$coefficients %>%
      data.frame() %>%
      slice(-1) %>%
      mutate(sig = ifelse(Pr...t.. < 0.05, '*', '')) %>%
      pull(sig)
    
    return(c(test[1], 'ref', test[2]))
  })
}

Sigtest(df = df, var = Var[2])

sigTest <- function(df, x, y){
  lm(formula = x~y) %>% 
    summary() %>%
    .$coefficients %>% 
    data.frame() %>% 
    slice(-1) %>% 
    mutate(sig = ifelse(Pr...t.. < 0.05,'*', '-')) %>%
    pull(sig)
}

df %>% 
  sigTest('LastInfection', 'Gloabal Shedding')

test <- lm(formula = Cumulative_I~GlobalShedding_p, data = df) %>% 
  summary() %>%
  .$coefficients %>% 
  data.frame() %>% 
  slice(-1) %>% 
  mutate(sig = ifelse(Pr...t.. < 0.05,'*', '-')) %>% 
  pull(sig)

c(test[1], 'ref', test[2])
  

  df %>% 
  # group by variable
  group_by(GlobalShedding_p) %>% 
  summarise_at(.vars = c('AtkRate', 'Cumulative_I', 'Cumulative_I_r', 'Cumulative_I_s', 'Cumulative_H', 'D', 'LastInfection'),
                 .funs = c('mean' = ~round(wilcox.test(., conf.int = T)$estimate, 2),
                           'q05' = ~round(wilcox.test(., conf.int = T)$conf.int[1], 2),
                           'q95' = ~round(wilcox.test(., conf.int = T)$conf.int[2], 2))) 

test <- df %>% 
  # calculate N, mean and confidence int
  pull(Cumulative_I) %>% 
  wilcox.test(., conf.int = T, alternative = 'two.sided', conf.level = 0.95)

test$estimate
```


## Bivar

```{r bivariate boxplot, fig.height=7, fig.width=7}
BoxPlot.Bi <- function(d, x, y, z, ColPal = c(1, 2, 3)) {
  d %>%
    group_by(seed, {{y}}, {{z}}) %>%
    filter(cycle == max(cycle)) %>%
    ggplot() +
    geom_boxplot(aes({{x}}, fill = {{y}}), alpha = 0.6) +
    facet_wrap(vars({{z}}))+
    coord_flip() +
     scale_fill_manual(values = ColPal) +
    theme_minimal() +
    theme(axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        strip.background = element_rect(colour="black",
                                        fill="grey90")) +
    theme(legend.position = 'top')
}
dc <- d$EC %>% 
  # filter(Introduction_p == 0.01) %>%
  # filter(vaccination_dist == 0) %>%
  # filter(GlobalShedding_p %in% c(0.25)) %>%
  # filter(vaccination_dist != 0) %>%
  group_by(seed) %>% 
  slice(n())%>% 
  mutate(Cumulative_I = Cumulative_I_r + Cumulative_I_s, D = D*4)

PSc <- list()

PSc[[1]] <- d$Cum %>% 
  mutate(Introduction_p = factor(Introduction_p, levels = c('Low', 'Medium', 'High'))) %>%
  filter(vaccination_dist == 0) %>% 
  # mutate(TestingFreq = relevel(TestingFreq, ref = '7')) %>% 
  filter(PPE_OR == c(0.1467)) %>%
  # filter(PPE_OR %in% c(0.1467),  detection_p %in% c(1.2*0.8)) %>%
  BoxPlot.Bi(d = ., x = AtkRate, y = TestingFreq, z = Introduction_p, ColPal =  c("#C70704", "#BAB700", "#008C0C"))

PSc[[2]] <- filter(d$EC, PPE_OR == 0.1467) %>%
  mutate(Introduction_p = factor(Introduction_p, levels = c('Low', 'Medium', 'High'))) %>%
  filter(vaccination_dist != 0) %>% 
  mutate(`Vaccination Distribution` = recode(vaccination_dist, `0.3` = 'Resident Priority', `0.5` = 'Equal', `0.7` = 'Staff priority')) %>% 
  BoxPlot.Bi(d = ., x = AtkRate, y = `Vaccination Distribution`, z = Introduction_p, ColPal <- c("#414042", "#8C8700", "#5D0DB3"))

# PSc[[3]] <- filter(d$EC, PPE_OR == 0.1467) %>%
#   filter(vaccination_dist != 0) %>% 
#   mutate(`Vaccine Efficacy` = recode(VaccineEff, `A` = 'Pfizer', `B` = 'Moderna' )) %>% 
#   BoxPlot.Bi(d = ., x = AtkRate, y = `Vaccine Efficacy`, z = Introduction_p, ColPal <- c("#5C9669", "#6A918C", "#7280B3"))

ggarrange(plotlist = PSc, ncol = 1) %>%
  ggsave(filename = '../../Documentation/Figures/V2/Scenarios.png', width = 7, height = 7)
```


```{r}
d$Cum %>% 
  mutate(Introduction_p = factor(Introduction_p, levels = c('Low', 'Medium', 'High'))) %>%
  filter(vaccination_dist == 0) %>% 
  # mutate(TestingFreq = relevel(TestingFreq, ref = '7')) %>% 
  # filter(PPE_OR == c(0.1467)) %>%
  # filter(PPE_OR %in% c(0.1467),  detection_p %in% c(1.2*0.8)) %>%
  BoxPlot.Bi(d = ., x = AtkRate, y = TestingFreq, z = GlobalShedding_p, ColPal =  c("#C70704", "#BAB700", "#008C0C"))

d$Cum %>% 
  mutate(Introduction_p = factor(Introduction_p, levels = c('Low', 'Medium', 'High'))) %>%
  filter(vaccination_dist != 0) %>%
  # mutate(TestingFreq = relevel(TestingFreq, ref = '7')) %>% 
  # filter(PPE_OR == c(0.1467)) %>%
  # filter(PPE_OR %in% c(0.1467),  detection_p %in% c(1.2*0.8)) %>%
  BoxPlot.Bi(d = ., x = AtkRate, y = vaccination_dist, z = GlobalShedding_p, ColPal =  c("#C70704", "#BAB700", "#008C0C"))
```



```{r}
BTbl <- list()

BTbl[[1]] <- lapply(unique(d$Cum$Introduction_p), function(y){
  lapply(Outcomes, function(x){
  LmCI(d = d$Cum  %>%
         mutate(TestingFreq = relevel(TestingFreq, ref = '7')) %>% 
         filter(vaccination_dist == 0) %>% 
         filter(PPE_OR == c(0.1467)) %>%
         filter(Introduction_p == y),
       f = paste0(x, '~', 'TestingFreq'))
}) %>% 
  do.call(cbind, .) %>% 
  data.frame() %>%
    `names<-`(Outcomes) %>% 
  mutate(Var = rownames(.)) %>% 
    mutate(y = y)
}) %>% 
  do.call(rbind,.)

BTbl[[2]] <- lapply(unique(d$Cum$Introduction_p), function(y){
  lapply(Outcomes, function(x){
  LmCI(d = d$Cum  %>%
         filter(vaccination_dist != 0) %>% 
         mutate(vaccination_dist = relevel(vaccination_dist, ref = '0.5')) %>% 
         filter(Introduction_p == y),
       f = paste0(x, '~', 'vaccination_dist'))
}) %>% 
  do.call(cbind, .) %>% 
  data.frame() %>%
    `names<-`(Outcomes) %>% 
  mutate(Var = rownames(.)) %>% 
    mutate(y = y)
}) %>% 
  do.call(rbind,.)

BTbl %>% 
  do.call(rbind, .) %>% 
  write.csv('../../Documentation/Tables/Biv.csv', quote = F, row.names = F)
```


```{r}
LmSum <- function(f, d){
   m <- lm(f, d)
   coef <- round(m$coefficients, 4)
   ci <- round(confint(m), 4)

   data.frame(coef, ci) %>% 
     slice(-1) %>% 
     mutate(var = row.names(.), Est = paste0(coef, ' (', ci[1,], ',',ci[2,], ')')) %>% 
     select(var, Est) %>% 
     return()
}
```

```{r}
# Testing Frequency --------------
dc %>% 
  mutate(TestingFreq = relevel(TestingFreq, ref = '7')) %>% 
  # filter(detection_p %in% c(1.2*0.8))
  filter(PPE_OR %in% c(0.1467)) %>% 
  filter(vaccination_dist == 0.0) %>% 
  filter(Introduction_p == 'Low') %>%
  LmSum('AtkRate~TestingFreq', d = .)

dc %>% 
  mutate(TestingFreq = relevel(TestingFreq, ref = '7')) %>% 
  # filter(detection_p %in% c(1.2*0.8)) %>% 
  filter(PPE_OR %in% c(0.1467)) %>% 
  filter(vaccination_dist == 0.0) %>% 
  filter(Introduction_p == 'Medium') %>%
  LmSum('AtkRate~TestingFreq', d = .)

dc %>% 
  mutate(TestingFreq = relevel(TestingFreq, ref = '7')) %>% 
  # filter(detection_p %in% c(1.2*0.8)) %>% 
  filter(PPE_OR %in% c(0.1467)) %>% 
  filter(vaccination_dist == 0.0) %>% 
  filter(Introduction_p == 'High') %>%
  # lm(Cumulative_I~TestingFreq, .) %>% 
  # summary()
  LmSum('AtkRate~TestingFreq', d = .)
```




```{r}
dc %>% 
  mutate(TestingFreq = relevel(TestingFreq, ref = '7')) %>% 
  filter(PPE_OR %in% c(0.1467),  detection_p %in% c(1.2*0.8)) %>% 
  filter(Introduction_p == 'Medium') %>% 
  lm(Cumulative_I~TestingFreq, data = .) %>% 
  summary()

test <- dc %>% 
  mutate(TestingFreq = relevel(TestingFreq, ref = '7')) %>% 
  filter(PPE_OR %in% c(0.1467),  detection_p %in% c(1.2*0.8)) %>%
  filter(Introduction_p == 'High') %>% 
  lm(Cumulative_I~TestingFreq, data = .)
coef <- round(test$coefficients, 4)
ci <- round(confint(test), 4)

data.frame(coef, ci)


# Vaccine distribution --------------
dc %>% 
  filter(vaccination_dist != 0) %>% 
  filter(PPE_OR %in% c(0.1467)) %>% 
  filter(Introduction_p == 'Low') %>% 
  LmSum('Cumulative_I~vaccination_dist', d = .)

dc %>% 
  filter(vaccination_dist != 0) %>% 
  filter(PPE_OR %in% c(0.1467)) %>% 
  filter(Introduction_p == 'Medium') %>% 
  LmSum('Cumulative_I~vaccination_dist', d = .)

dc %>% 
  filter(vaccination_dist != 0) %>% 
  filter(PPE_OR %in% c(0.1467)) %>% 
  filter(Introduction_p == 'High') %>% 
  LmSum('Cumulative_I~vaccination_dist', d = .)
# Tables ------------------
dc %>% 
  group_by(Introduction_p, TestingFreq) %>% 
  SumTbl() %>% 
  select(Introduction_p:TestingFreq, LastInfection:D) %>% 
  arrange(desc(Introduction_p, TestingFreq))

dc %>% 
  group_by(Introduction_p, vaccination_dist) %>% 
  SumTbl() %>% 
  select(Introduction_p:vaccination_dist, LastInfection:D) %>% 
  arrange(desc(Introduction_p, vaccination_dist))

dc %>% 
  group_by(Introduction_p, VaccineEff) %>% 
  SumTbl() %>% 
  select(Introduction_p:VaccineEff, LastInfection:D) %>% 
  arrange(desc(Introduction_p, VaccineEff))
```

## GSA

```{r}
dc <- d$Cum %>% 
  # filter(Introduction_p == 0.01) %>%
  # filter(vaccination_dist == 0) %>%
  # filter(GlobalShedding_p %in% c(0.25)) %>%
  # filter(vaccination_dist != 0) %>%
 mutate_at(.vars = c('GlobalShedding_p', 'detection_p', 'AsymptTransmission', 'SR_OR'), .funs = ~factor(., labels = c('Low', 'Med', 'High')))%>% 
  mutate(PPE_OR = factor(PPE_OR, labels = c('High', 'Med', 'Low'))) %>% 
  mutate(vaccination_dist = recode(vaccination_dist, `0` = 'No vaccinaiton', `0.3` = 'Resident', `0.5` = 'Equal', `0.7` = 'Staff')) %>% 
  mutate(Cumulative_I = Cumulative_I_r + Cumulative_I_s)

####### Function to get the plots ##########
RFCART <- function(data, f, main = '', seed = 1, palette  ='-RdYlGn'){
  PL <- list()
  
  set.seed(seed)
  # Split the data train/test
  ind <- sample(2, nrow(data), replace = TRUE, prob = c(0.7, 0.3))
  train <- data[ind==1,]
  test <- data[ind==2,]
  # Random Forest model fit
  rf <- randomForest::randomForest(f, data=train, proximity=TRUE) 
  print(rf)
  
  # Variable importance
  PL[[2]] <- importance(rf) %>%
    data.frame() %>% 
    mutate(variable = rownames(.), RelImpt = IncNodePurity/sum(IncNodePurity)) %>%
    ggplot(aes(x = reorder(variable, RelImpt), y = RelImpt)) +
    geom_col() +
    coord_flip() +
    labs(x = 'Parameters', y = 'Relative Importance', title = main) +
    theme_minimal()
  
  # tr <- tree::tree(f, data=data)
  # plot(tr); text(tr)
  fit <- rpart(f, data=data, method = 'anova')
  PL[[1]] <- rpart.plot::rpart.plot(fit, type = 4, box.palette = palette, branch.lty = 2)
  
  return(PL)
}

dc <- dc %>% 
  mutate(Infection_p = GlobalShedding_p, `Asymptomatic transmission` = AsymptTransmission)

# Cummulative Infected
f1 <- Cumulative_I ~ Infection_p + AsymptTransmission + Introduction_p + TestingFreq + detection_p + PPE_OR + vaccination_dist + VaccineEff

RFCART(data = dc, f = f1)

# Cummulative Hosp
f2 <- Cumulative_H ~ Infection_p + AsymptTransmission + Introduction_p + TestingFreq + detection_p + PPE_OR + vaccination_dist + VaccineEff

RFCART(data = dc, f = f2)

# Cummulative Deaths
f3 <- D ~ Infection_p + AsymptTransmission + Introduction_p + TestingFreq + detection_p + PPE_OR + vaccination_dist + VaccineEff
RFCART(data = dc, f = f3)
```



```{r}
## Export the results
png(filename = '../../Documentation/Figures/V2/CumRTI.png', width = 6.5, height = 5,res = 300, units = 'in')
Ps <- RFCART(f = f1 ,data = dc, 
             main = '')
dev.off()
Ps[[2]]  %>%
  ggsave(filename = '../../Documentation/Figures/V2/CumI-VI.png', plot = ., width = 6.5, height = 2)

## Export the results
png(filename = '../../Documentation/Figures/V2/DRT.png', width = 6.5, height = 5,res = 300, units = 'in')
Ps <- RFCART(f = f3 ,data = dc, 
             main = '')
dev.off()
Ps[[2]]  %>%
  ggsave(filename = '../../Documentation/Figures/V2/D-VI.png', plot = ., width = 6.5, height = 2)
```


```{r Interactive version}
library(visNetwork)
r <- rpart(formula = f1, data = dc)

visTree(r, 
        colorEdges = '#6E0E0CC9', # color of the edges
        shapeY = 'diamond', # shpe of the outcome
        colorY = c("#F2D600", "#EB0400")) # color gradient c(min, max)
```



## Network

```{r}
library(ggraph)
library(tidygraph)
# Function to plot the network
PlotNet <- function(N, size = 'indegree', layout = 'kk'){  
  ggraph(graph = N, layout = layout) +
    geom_edge_link(alpha = 0.3) +
    geom_node_point(aes_string(size = size), alpha = 0.5)
}

d$N <- d$N %>% 
  mutate(type = ifelse(from == 'Community', 'Community', 0),
         type = ifelse(gsub('[0-9]', '', from) == 'Staff' & gsub('[0-9]', '', to) == 'Staff', 'Staff', type),
         type = ifelse(gsub('[0-9]', '', from) == 'Residents' & gsub('[0-9]', '', to) == 'Residents', 'Residents', type),
         type = ifelse(gsub('[0-9]', '', from) == 'Residents' & gsub('[0-9]', '', to) == 'Staff', 'Residents-Staff', type),
         type = ifelse(gsub('[0-9]', '', from) == 'Staff' & gsub('[0-9]', '', to) == 'Residents', 'Staff-Residents', type))

d$N %>% 
  as_tbl_graph() %E>% 
  filter(type == 'Residents') %N>%
  filter(!node_is_isolated()) %>% 
  mutate(indegree = centrality_degree(mode = 'in')) %>%
  PlotNet()
```


```{r}
x <- unique(d$EC$AsymptTransmission)

# d$EC %>% 
#   filter(PPE_OR == x[2]) %>% #c('0.304', '0.380', '0.456')
#   group_by(cycle) %>% 
#   summarise_at(c('Cumulative_I'), .funs = ~mean(., na.rm = T)) %>% 
#   ggplot(aes(x = cycle)) +
#   geom_line(aes(y = Cumulative_I))


d$EC %>% 
  group_by(cycle, AsymptTransmission) %>% 
  summarise_at(c('Cumulative_I'), .funs = ~mean(., na.rm = T)) %>% 
  ggplot(aes(x = cycle)) +
  geom_line(aes(y = Cumulative_I, col = factor(AsymptTransmission)))
```


```{r}
d$EC %>% 
    mutate(day = floor(cycle/24)) %>% 
    group_by(seed) %>% 
    mutate(L = n()) %>% ungroup() %>% mutate(mL = max(L), dL = mL - L) %>%  group_by(seed) %>% slice(c(1:n(),rep(n(), max(dL)))) %>% 
    ungroup() %>% arrange(seed, day) %>% 
    group_by(day, GlobalShedding_p) %>% 
    summarise(MeanCI = mean(Cumulative_I), MedianCI = median(I)) %>% 
  arrange(GlobalShedding_p, day)
   ggplot() +
  geom_line(aes(day, MeanCI, col = factor(GlobalShedding_p)), lwd = 0.5) +
  Pabloverse::Theme1()
```


```{r univar}
ICurveP(GlobalShedding_p)
ICurveP(TestingFreq)
ICurveP(PPE_OR)
ICurveP(VaccineEff)
```

```{r bivariate}
d$EC %>% 
  # filter(p2 == 1) %>% 
    group_by(cycle, GlobalShedding_p, VaccineEff) %>% 
    summarise(MeanCI = mean(Cumulative_I), MedianCI = median(Cumulative_I)) %>% 
   ggplot() +
  geom_line(aes(cycle, MeanCI, col = factor(VaccineEff)), lwd = 0.6) +
  facet_wrap(~GlobalShedding_p, scales = 'free_y') +
  Pabloverse::Theme1() +
  theme(legend.position = 'top')
```


```{r}
ds <- d$EC %>% 
  # mutate_at(c('Cumulative_I', 'Cumulative_I_r','Cumulative_I_s', 'Cumulative_H', 'D'), .funs = ~./N) %>% 
  ## THIS CHUNK IS TO REMOVE THE TAILS OF 95%
  # group_by(seed) %>% 
  # mutate(Cumulative_I_c = max(Cumulative_I)) %>% data.frame() %>%
  # filter(Cumulative_I_c < quantile(Cumulative_I_c, probs = 0.95), Cumulative_I_c > quantile(Cumulative_I_c, probs = 0.05)) %>% data.frame() %>% 
  group_by(seed, .dots=lapply(Var, as.symbol)) %>% 
  summarise_at(c('Cumulative_I', 'Cumulative_I_r','Cumulative_I_s', 'Cumulative_H', 'D', 'LastInfection'), .funs = max) %>% 
  ungroup() %>% 
  mutate_at(.vars = Var, .funs = factor) %>%
  mutate(LastInfection = (LastInfection/24)+7) %>% 
  select(-seed)


f1 <- Cumulative_I ~ GlobalShedding_p + Introduction_p + TestingFreq + PPE_OR + Test_sensitivity + vaccination_dist + VaccineEff
f2 <- Cumulative_I_r ~ GlobalShedding_p + Introduction_p + TestingFreq + PPE_OR + Test_sensitivity + vaccination_dist + VaccineEff
f3 <- Cumulative_I_s ~ GlobalShedding_p + Introduction_p + TestingFreq + PPE_OR + Test_sensitivity + vaccination_dist + VaccineEff
f4 <- LastInfection ~ GlobalShedding_p + Introduction_p + TestingFreq + PPE_OR + Test_sensitivity + vaccination_dist + VaccineEff

RFCART(f = f1 ,data = ds, main = 'Variable contribution for cumulative infected')
RFCART(f = f2 ,data = ds, main = 'Variable contribution for cumulative infected (residents)')
RFCART(f = f3 ,data = ds, main = 'Variable contribution for cumulative infected (staff)')
RFCART(f = f4 ,data = ds, main = 'Variable contribution for las day of infection')
```


## Scenarios

```{r}
ScenarioSum <- function(scenario, var){
  # scenario <- 'VacinationReplacement'; var = 'pInfected'
  ds %>% 
    mutate(Testing5 = ifelse(TestingFreq %in% c('3','5'), 1, 0),
           Testing3 = ifelse(TestingFreq == '3', 1, 0)) %>% 
    # mutate_at(.vars = scenarios, ~recode(., `Yes` = '1', `No` = '0')) %>% 
    # mutate(VacTest = ifelse(VacinationReplacement == 1 & ReplacementTesting == 1, 1, 0),
    #        ReplacementTesting = ifelse(ReplacementTesting == 1, 0, 1)) %>% 
    group_by(eval(parse(text = scenario))) %>%
  summarise(Var = mean(eval(parse(text = var)))) %>%
    rename(scenario = `eval(parse(text = scenario))`) %>% 
  tidyr::spread(data = ., key = scenario, Var) %>% 
  mutate(S = scenario)
}

ScenarioSum(scenario = 'Testing3', var = 'Cumulative_I')
```


```{r}
scenarios <- c('EmergencyVaccination', 'movement_restrictions', 'detection14', 'detection7', 'Culling')

ScenarioSum <- function(scenario, var){
  # scenario <- 'VacinationReplacement'; var = 'pInfected'
  d %>% 
    mutate(detection14 = ifelse(detection_effect == '14', 1, 0),
           detection7 = ifelse(detection_effect == '7', 1, 0),
           Culling = ifelse(CullingRate == '0', 1, 0)) %>% 
    # mutate_at(.vars = scenarios, ~recode(., `Yes` = '1', `No` = '0')) %>% 
    # mutate(VacTest = ifelse(VacinationReplacement == 1 & ReplacementTesting == 1, 1, 0),
    #        ReplacementTesting = ifelse(ReplacementTesting == 1, 0, 1)) %>% 
    group_by(eval(parse(text = scenario))) %>%
  summarise(Var = mean(eval(parse(text = var)))) %>%
    rename(scenario = `eval(parse(text = scenario))`) %>% 
  tidyr::spread(data = ., key = scenario, Var) %>% 
  mutate(S = scenario)
}

Ss <- lapply(scenarios, ScenarioSum, var = 'CumulativeInfected') %>% 
  do.call(rbind, .) %>% 
  rename(Yes = '1', No = '0')


 Pr <- Ss %>%
  mutate(Reduction = abs(round((1 - (Yes/No))*100, 2))) %>% 
  # arrange(desc(`0`))
  # filter(S == 'ConfirmatoryTesting') %>% 
  ggplot(aes(x = S)) +
  geom_bar(aes(y = No), alpha = 0.8, fill = 'red3', col = 'black', stat="identity", width = 0.5) +
  geom_bar(aes(y = Yes), alpha = 0.6, fill = 'green', stat="identity", width = 0.48) +
    geom_text(aes(y = No, label = paste0('-', Reduction, '%')), hjust = 3, col = 'grey90') +
  coord_flip() +
  Theme1() +
  labs(y = '', x = '', title = 'Reduction of interventions in cumulative infected herds')
 
Pr %>%
  ggsave(filename = '../../Docs/Figures/Reduction.png', width = 8, height = 4)
```



```{r}
scenarios <- c('ReplacementTesting', 'PigletVaccination', 'VacinationReplacement', 'HerdClosure')

Ss <- lapply(scenarios, ScenarioSum, var = 'pInfected') %>% 
  do.call(rbind, .) %>% 
  mutate(var = 'Sow Cumulative incidence')

Ss <- Ss %>% 
  rbind(
    lapply(scenarios, ScenarioSum, var = 'FarrowingMortality') %>% 
  do.call(rbind, .) %>% 
    mutate(var = 'Piglets Cumulative incidence')
  )

Ss <- Ss %>%
  rbind(
    lapply(scenarios, ScenarioSum, var = 'LastInfected') %>%
  do.call(rbind, .) %>%
    mutate(var = 'Time to elimination')
  )

Pr <- Ss %>%
  mutate(Reduction = abs(round((1 - (Yes/No))*100, 2))) %>% 
  # arrange(desc(`0`))
  # filter(S == 'ConfirmatoryTesting') %>% 
  ggplot(aes(x = S)) +
  geom_bar(aes(y = No), alpha = 0.8, fill = 'red3', col = 'black', stat="identity", width = 0.5) +
  geom_bar(aes(y = Yes), alpha = 0.6, fill = 'green', stat="identity", width = 0.48) +
    geom_text(aes(y = No, label = paste0('-', Reduction, '%')), hjust = 3, col = 'grey90') +
  coord_flip() +
  facet_wrap(~var, scales = 'free_x') +
  Theme1() +
  labs(y = '', x = '', title = 'Reduction of interventions in outcomes analyzed')


Pr 

```
