---
title: "Validation"
output: pdf_document
---

```{r include = F}
knitr::opts_chunk$set(echo = F, warning = F, message = F)
```


```{r include=FALSE}
library(dplyr); library(MuMIn); library(lme4); library(ggplot2); library(ggpubr)
# ==============================================================================
# FUNCTIONS
# ==============================================================================
# Read Simulations
# ------------------------------------------------------------------------------
ReadSims <- function(dir){
  # dir = paste0(p, "00/EC/")
  f <- list.files(dir, full.names = TRUE)
  L <- lapply(1:length(f), function(x){
    read.csv(f[x], fileEncoding = 'UTF-8') %>% # read files
      mutate(Sim = x, day = ceiling(cycle/24)) %>% # create variable for sim number and day
      group_by(Sim, day) %>% # group by simulation and day
      summarise_all(.funs = max) %>%# get the max for all the records.
      ungroup()
    })
  
  N_sim <- lapply(L, nrow) %>% unlist() %>% max(.)
  
  L <- lapply(L, function(x){
    d <- N_sim - nrow(x)
      x %>%
        slice(c(1:nrow(.), rep(nrow(.), each = d))) %>%
        mutate(day = 1:n())
  })
  L %>%
    do.call(rbind, .)
}
# Functions for getting quantiles
# ------------------------------------------------------------------------------
Q05 <- function(sims) quantile(sims, 0.05)
Q25 <- function(sims) quantile(sims, 0.25)
Q75 <- function(sims) quantile(sims, 0.75)
Q95 <- function(sims) quantile(sims, 0.95)
```


```{r Expected, eval=FALSE, include=FALSE}
p <- "../../Data/SimsOut/Baseline/"
### Baseline
Bbs <- ReadSims(p)  %>% 
  mutate(CumI = Cumulative_I_r + Cumulative_I_s, type = "simulated")

Exp <- select(.data = Bbs, day, CumI, type, Ir_cumsum = Cumulative_I_r, Is_cumsum = Cumulative_I_s, Sim)
```


```{r Observed, eval=FALSE, include=FALSE}
# Load and filter the CMS data
CMS_CA <- read.csv("../../Data/CMS/COVID-19_Nursing_Home_Dataset.csv") %>%
  mutate(date = as.Date(Week.Ending, format = '%m/%d/%Y')) %>% 
  filter(Provider.State == "CA")

range(CMS_CA$date)

# Format the data:
CMSCA_ts <- CMS_CA %>% replace(is.na(.), 0) %>%
  select(date, Provider = Federal.Provider.Number, Ir = Residents.Weekly.Confirmed.COVID.19, Is = Staff.Weekly.Confirmed.COVID.19, Dr = Residents.Weekly.COVID.19.Deaths, OccBeds = Total.Number.of.Occupied.Beds) %>%
  arrange(Provider, date) %>%
  group_by(Provider) %>%
  mutate_at(.vars = c('Ir', 'Is', 'Dr'), .funs = c('cumsum', 'sum')) %>%
  mutate(CumI = Ir_cumsum + Is_cumsum,
         TotalI = Ir_sum + Is_sum) %>%
  filter(CumI > 0) %>%
  mutate(OccBeds = max(OccBeds), 
         d = date - first(date), 
         p_infection = Ir_sum/OccBeds, 
         I = Ir + Is) %>%
  filter(between(OccBeds, 160, 200),
         TotalI != CumI)

Obs <- CMSCA_ts %>% data.frame() %>%
  filter(d < 150) %>%
  mutate(day = d, type = "observed") %>%
  select(day, CumI, type, Ir_cumsum, Is_cumsum, Sim = Provider)
```

```{r Data from interviewed NH, eval=FALSE, include=FALSE}
CVS <- CMS_CA %>%
  filter(Provider.Name == 'CLEAR VIEW SANITARIUM') %>%
  arrange(date) %>%
  filter(Residents.Total.Confirmed.COVID.19 > 0) %>% 
  mutate(I = Residents.Total.Confirmed.COVID.19 + Staff.Total.Confirmed.COVID.19) %>%
  select(Provider = Federal.Provider.Number, I, date, Ir_cumsum = Residents.Total.Confirmed.COVID.19, IS_cumsum = Staff.Total.Confirmed.COVID.19) %>% 
  mutate(day = date - first(date))
# %>% 
#   group_by(Federal.Provider.Number) %>% 
#   
#   ggplot() +
#   geom_path(aes(x=d, y=Residents.Total.Confirmed.COVID.19))
```


```{r Export the data, eval=FALSE, include=FALSE}
## Clear view san data
# CVS %>%
#   write.csv('../../Data/SimsOut/CVS.csv', row.names = F)
## Observed
# rbind(Obs, Exp) %>%
#   mutate(day = as.numeric(day)) %>%
#   write.csv("../../Data/SimsOut/O_E.csv", row.names = F)
```


```{r Load the data}
d <- read.csv('../../Data/SimsOut/O_E.csv')
CVS <- read.csv('../../Data/SimsOut/CVS.csv')
```


# Observed vs expected plot


```{r simulated outbreaks}

d  %>%
  group_by(day, type) %>%
  summarise_at(.vars = c('CumI'), .funs = c(Median = median, Q25 = Q25, Q75 = Q75)) %>%
  ggplot(aes(x = day)) +
  geom_path(aes(y = Median, col = type), lwd = 1.2) +
  geom_ribbon(aes(ymin = Q25, ymax = Q75, fill = type, col = type),lwd = 0.01, alpha = 0.15) +
  geom_point(data = CVS, aes(y = I), shape = 18, size = 2.5, col = 'black') +
  scale_color_manual(values = c('red3', "blue3")) +
  scale_fill_manual(values = c('red', "blue")) +
  theme_minimal() + ggtitle("All infections")
  
pR <- d %>%
  group_by(day, type) %>%
  summarise_at(.vars = c('Ir_cumsum'), .funs = c(Median = median, Q25 = Q25, Q75 = Q75)) %>%
  ggplot(aes(x = day)) +
  geom_path(aes(y = Median, col = type), lwd = 1.2) +
  geom_ribbon(aes(ymin = Q25, ymax = Q75, fill = type, col = type), alpha = 0.1) +
  geom_point(data = CVS, aes(y = Ir_cumsum), shape = 18, size = 2.5, col = 'black') +
  ggtitle("Residents") +
  scale_color_manual(values = c('red3', "blue3")) +
  scale_fill_manual(values = c('red2', "blue2")) +
  theme_minimal()

pS <- d %>%
  group_by(day, type) %>%
  summarise_at(.vars = c('Is_cumsum'), .funs = c(Median = median, Q25 = Q25, Q75 = Q75)) %>%
  ggplot(aes(x = day)) +
  geom_path(aes(y = Median, col = type), lwd = 1.2) +
  geom_ribbon(aes(ymin = Q25, ymax = Q75, fill = type, col = type), alpha = 0.1) +
  geom_point(data = CVS, aes(y = IS_cumsum), shape = 18, size = 2.5, col = 'black') +
  ggtitle("Staff") +
  scale_color_manual(values = c('red3', "blue3")) +
  scale_fill_manual(values = c('red2', "blue2")) +
  theme_minimal()

ggarrange(pR, pS, widths = c(5, 5), common.legend = T) %>%
  annotate_figure(top = "Observed vs simulated outbreaks") 
# %>%
#   ggsave(filename = "../../Documentation/Figures/SensitivityAnalysis/ObservedvExp.png", width = 7, height = 4)
```

# Correlation of observed and expected

## Using the median

This approach uses only the median and we weould be loosing some information here, but I think is the easiest to interpret.  

I calculated the correlation between the median number of infected for the simulated and observed cases, and used a simple linear regression where: $Observed\sim Simulated$ and obtained the $R^2$.  

```{r}
dm <- d %>%
  group_by(day, type) %>%
  summarise_at(.vars = c('CumI', 'Ir_cumsum', 'Is_cumsum'), .funs = median) %>%
  arrange(type) %>%
  data.frame()

odays <- dm %>%
  filter(type == 'observed') %>%
  pull(day)

dms <- dm %>%
  filter(day %in% odays, 
         day != 0) %>%
  split(.$type)

#Correlation
pIt <- cor(dms$observed$CumI, dms$simulated$CumI)
pIr <- cor(dms$observed$Ir_cumsum, dms$simulated$Ir_cumsum)
pIs <- cor(dms$observed$Is_cumsum, dms$simulated$Is_cumsum)

R2t <- lm(dms$observed$CumI~dms$simulated$CumI) %>%
  summary() %>%
  .$r.squared

R2r <- lm(dms$observed$Ir_cumsum~dms$simulated$Ir_cumsum) %>%
  summary() %>%
  .$r.squared

R2s <- lm(dms$observed$Is_cumsum~dms$simulated$Is_cumsum) %>%
  summary() %>%
  .$r.squared
```

|Model             |$\rho$  |$R^2$  |
|------------------| -------|-------|
|Total Infected    | `r pIt`|`r R2t`|
|Infected Residents| `r pIr`|`r R2r`|
|Infected Staff    | `r pIs`|`r R2s`|


## Using a simple linear regression fro individual observations.    
In the following two approaches we used all the observations (simulated and observed), so this could provide us a better insight, but I am not so sure if the model specification I am doing is correct.

To calculate the $R^2$ we used model 

$$Y_i\sim X_1+X_2+X_3$$
Where:  
  
  - $Y_i$ represent the cumulative number of infected.  
  - $X_1$ if its from an observed or simulated outbreak.  
  - $X_2$ the day since the outbreak.  
  - $X_3$ the number of simulation or outbreak ID.  
  
We did a model for the cumulative number of residents infected, cumulative number of staff infected, and total cumulative number of infected (residents+staff).  


```{r}
R2t <- d %>%
  lm(formula = CumI~type + day + Sim, data = .) %>%
  summary() %>%
  .$r.squared

R2r <- d %>%
  lm(formula = Ir_cumsum~type + day + Sim, data = .) %>%
  summary() %>%
  .$r.squared

R2s <- d %>%
  lm(formula = Is_cumsum~type + day + Sim, data = .) %>%
  summary() %>%
  .$r.squared
```


| $Y_i$            | $R^2$  |
|------------------|--------|
|Total Infected    | `r R2t`|
|Infected residents| `r R2r`|
|Infected Staff    | `r R2s`|
  
## Using a LMM to calculate a pseudo $R^2$

We used the package `MuMIn` which can be used to estimate a pseudo $R^2$[@REF].  
This approach calculate a marginal $R^2$, which represents the variance explained by the fixed effects, and a conditional $R^2$, which represents the variance explained by the random effect.  

```{r}
# Does small R2m means that the covariate is not relevant (a.k.a there is no difference, our model produces good estimates to the observed??)
pR2t <- d %>%
  lme4::lmer(formula = CumI~type + (1 + day|Sim), data = .) %>% 
  # lm(formula = CumI~type + day, data = .) %>%
  # summary() %>%
  MuMIn::r.squaredGLMM(.)

pR2s <- d %>%
  lme4::lmer(formula = Is_cumsum~type + (1 + day|Sim), data = .) %>% 
  # lm(formula = CumI~type + day, data = .) %>%
  # summary() %>%
  MuMIn::r.squaredGLMM(.)

pR2r <- d %>%
  lme4::lmer(formula = Ir_cumsum~type + (1 + day|Sim), data = .) %>% 
  # lm(formula = CumI~type + day, data = .) %>%
  # summary() %>% .$r.squared 
  MuMIn::r.squaredGLMM(.)
```

| $Y_i$            | Marginal $R^2$  | Conditional $R^2$|
|------------------|-----------------|------------------|
|Total Infected    |      `r pR2t[1]`|       `r pR2t[2]`|
|Infected residents|      `r pR2r[1]`|       `r pR2r[2]`|
|Infected Staff    |      `r pR2s[1]`|       `r pR2s[2]`|
  
  
My interpretation of this would be:  

A low marginal $R^2$ indicates that there is not much variation being explained by the fixed effects, which in our model is the type of outbreak (either simulated or observed), indicating that the model can not tell the difference when an outbreak is simulated or observed. This will indicate that our simulation model is good when replicating observed outbreaks.  
A high conditional $R^2$ indicates that most of the variation is being explained by the random effect. 



